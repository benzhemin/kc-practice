# Spring Profile: proxy
# Use this profile to enable proxy for capturing OAuth2 token exchange
#
# Usage: ./gradlew bootRun --args='--spring.profiles.active=proxy'

spring:
  application:
    name: api-gateway-keycloak

  security:
    oauth2:
      client:
        registration:
          keycloak:
            client-id: app-client
            client-secret: mEFz9aF5WBb6OAYRPVYm3rlTn3ylCBeF
            scope: openid,profile,email
            authorization-grant-type: authorization_code
            # Note: redirect_uri uses {baseUrl} which will be http://localhost:8080
            # This is OK because it's used by the browser, not by the application
            redirect-uri: "{baseUrl}/login/oauth2/code/gateway"

        provider:
          keycloak:
            # ✅ Using keycloak.local to bypass Reactor Netty's hardcoded proxy exclusion
            issuer-uri: http://keycloak.local:3081/realms/dev-realm
            user-name-attribute: preferred_username

      resourceserver:
        jwt:
          issuer-uri: http://keycloak.local:3081/realms/dev-realm
          jwk-set-uri: http://keycloak.local:3081/realms/dev-realm/protocol/openid-connect/certs

server:
  port: 8080

# ⭐ PROXY ENABLED - All traffic will go through proxy
proxy:
  enabled: true
  host: localhost
  port: 8888
  type: HTTP

logging:
  level:
    org.springframework.security: TRACE
    org.springframework.security.oauth2: TRACE
    org.springframework.web.reactive.function.client: TRACE
    reactor.netty.http.client: DEBUG
    com.zz.gateway: DEBUG
    org.springframework.security.oauth2.client.endpoint: TRACE
    org.springframework.security.oauth2.client.web: TRACE

