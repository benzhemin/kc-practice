# Proxy Fix - Visual Explanation

## Before Fix (BROKEN) âŒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      OAuth2 Authentication Flow                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Browser Redirect (Not proxied - this is normal)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ Keycloak â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   GET /auth?client_id=...             â”‚  :3081   â”‚
              (Direct connection - OK)             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Step 2: Token Exchange (SHOULD be proxied, but ISN'T!) âŒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Spring Boot  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€Xâ”€â”€>â”‚ mitmproxyâ”‚
â”‚ Application  â”‚   POST /token                     â”‚  :8888   â”‚
â”‚   :8080      â”‚   (Bypassed due to                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    nonProxyHosts!)                     
       â”‚                                                  
       â”‚ Direct connection                               
       â”‚ (Reactor Netty excludes localhost)              
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 POST /token                         â”‚ Keycloak â”‚
                 (Goes directly to :3081)            â”‚  :3081   â”‚
                                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Step 3: JWK Retrieval (SHOULD be proxied, but ISN'T!) âŒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Spring Boot  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€Xâ”€â”€>â”‚ mitmproxyâ”‚
â”‚ Application  â”‚   GET /certs                      â”‚  :8888   â”‚
â”‚   :8080      â”‚   (Bypassed!)                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          
       â”‚                                                  
       â”‚ Direct connection                               
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 GET /certs                          â”‚ Keycloak â”‚
                 (Goes directly to :3081)            â”‚  :3081   â”‚
                                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Step 4: UserInfo Request (SHOULD be proxied, but ISN'T!) âŒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Spring Boot  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€Xâ”€â”€>â”‚ mitmproxyâ”‚
â”‚ Application  â”‚   GET /userinfo                   â”‚  :8888   â”‚
â”‚   :8080      â”‚   (Bypassed!)                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          
       â”‚                                                  
       â”‚ Direct connection                               
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 GET /userinfo                       â”‚ Keycloak â”‚
                 (Goes directly to :3081)            â”‚  :3081   â”‚
                                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RESULT: You can't see tokens, can't debug, can't inspect traffic! ğŸ˜¢
```

---

## After Fix (WORKING) âœ…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      OAuth2 Authentication Flow                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Browser Redirect (Not proxied - this is normal)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ Keycloak â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   GET /auth?client_id=...             â”‚  :3081   â”‚
              (Direct connection - OK)             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Step 2: Token Exchange (NOW PROXIED!) âœ…
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Spring Boot  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ mitmproxyâ”‚
â”‚ Application  â”‚   POST /token                     â”‚  :8888   â”‚
â”‚   :8080      â”‚   (Through proxy!)                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
                                                        â”‚ Forward
                                                        â”‚
                                                        â–¼
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚ Keycloak â”‚
                                                   â”‚  :3081   â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   
You can now see:
- Authorization code
- Access token
- Refresh token
- ID token


Step 3: JWK Retrieval (NOW PROXIED!) âœ…
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Spring Boot  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ mitmproxyâ”‚
â”‚ Application  â”‚   GET /certs                      â”‚  :8888   â”‚
â”‚   :8080      â”‚   (Through proxy!)                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
                                                        â”‚ Forward
                                                        â”‚
                                                        â–¼
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚ Keycloak â”‚
                                                   â”‚  :3081   â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

You can now see:
- Public keys (JWK)
- Key IDs
- Algorithms


Step 4: UserInfo Request (NOW PROXIED!) âœ…
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Spring Boot  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ mitmproxyâ”‚
â”‚ Application  â”‚   GET /userinfo                   â”‚  :8888   â”‚
â”‚   :8080      â”‚   (Through proxy!)                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
                                                        â”‚ Forward
                                                        â”‚
                                                        â–¼
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚ Keycloak â”‚
                                                   â”‚  :3081   â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

You can now see:
- User attributes
- Email, name, etc.
- Custom claims


RESULT: Full visibility into OAuth2 flow! ğŸ‰
```

---

## The Technical Reason

### Default Behavior (JVM)

```
http.nonProxyHosts = "localhost|127.*|[::1]"
                      ^^^^^^^^
                      This causes the problem!
```

When Reactor Netty sees the target is `localhost:3081`, it checks:
1. Is proxy configured? âœ… Yes
2. Is target in `nonProxyHosts`? âœ… Yes (localhost matches)
3. **Decision:** Bypass proxy, connect directly

### After Our Fix

```java
// In ProxyConfig.java
System.clearProperty("http.nonProxyHosts");  // Remove JVM default

// In WebClientProxyCustomizer.java
proxy.nonProxyHosts("");  // Set to empty = no exclusions
```

Now when Reactor Netty checks:
1. Is proxy configured? âœ… Yes
2. Is target in `nonProxyHosts`? âŒ No (empty list)
3. **Decision:** Use proxy for ALL traffic

---

## Connection Details

### Before Fix
```
Reactor Netty Log:
[634bda26-1, L:/127.0.0.1:51322 - R:localhost/127.0.0.1:3081]
              ^                      ^
              Local socket           Remote = Keycloak (WRONG!)
```

### After Fix
```
Reactor Netty Log:
[634bda26-1, L:/127.0.0.1:51322 - R:localhost/127.0.0.1:8888]
              ^                      ^
              Local socket           Remote = Proxy (CORRECT!)
```

---

## mitmproxy View

### Before Fix (Empty)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ mitmproxy - Intercepting HTTP & HTTPS                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  (No OAuth2 traffic captured)                           â”‚
â”‚                                                          â”‚
â”‚  Only browser redirects visible (if any)                â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### After Fix (Full Traffic)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ mitmproxy - Intercepting HTTP & HTTPS                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  POST http://localhost:3081/.../token                   â”‚
â”‚    â† Authorization: Basic YXBwLWNsaWVudDp...            â”‚
â”‚    â†’ 200 OK                                             â”‚
â”‚    â†’ {"access_token":"eyJhbGc...", ...}                 â”‚
â”‚                                                          â”‚
â”‚  GET http://localhost:3081/.../certs                    â”‚
â”‚    â†’ 200 OK                                             â”‚
â”‚    â†’ {"keys":[{"kid":"abc123", ...}]}                   â”‚
â”‚                                                          â”‚
â”‚  GET http://localhost:3081/.../userinfo                 â”‚
â”‚    â† Authorization: Bearer eyJhbGc...                   â”‚
â”‚    â†’ 200 OK                                             â”‚
â”‚    â†’ {"sub":"john", "email":"john@test.com", ...}       â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Takeaways

1. **JVM's `nonProxyHosts`** excludes localhost by default
2. **Reactor Netty** respects this exclusion
3. **Spring Security OAuth2** uses Reactor Netty
4. **Solution:** Explicitly clear the exclusion list
5. **Result:** Full visibility into OAuth2 authentication flow

## Files to Change

```
src/main/java/com/zz/gateway/auth/config/
â”œâ”€â”€ ProxyConfig.java              â† Add System.clearProperty()
â””â”€â”€ WebClientProxyCustomizer.java â† Add .nonProxyHosts("")
```

That's it! Two small changes, big impact! ğŸš€

